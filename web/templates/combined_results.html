{% extends "base.html" %}
{% from "utils.html" import cell_type, uber_search_head, uber_search_body %}
{% block title %}Results{% endblock %}
{%- macro filtered_count(total, pf, reasons) -%}
{% if total == pf %}{{ pf }}{% else -%}
{% set line_break=joiner("<br>"|safe) %}
<span style="text-decoration-line: line-through">{{ total }}</span> {{ pf }}
<span class="tooltip">&#x26A0;
    <span class="tooltiptext">{% for el in reasons if el._id is not none %}{{ line_break() }}{{ el._id }}: {{ el.count }}{% endfor %}</span>
</span>
{%- endif %}
{%- endmacro -%}
{%- macro result_link(count, geneSet, result) -%}
{%- if count > 0 -%}
<a href="{{ url_for('ui.download_results', study=result.study, virus=result.virus, cell_type=result.bto_name, platform=result.platform, geneSet=geneSet) }}">
{%- endif -%}
{{ count }}{{ "</a>"|safe if count > 0 }}
{%- endmacro -%}
{%- macro platform(name) -%}
{%- if name is defined %}<img class="geo_icon" src="{{ url_for('static', filename='array.png') }}"/> <abbr title="Array type">{{ name }}</abbr>
{%- else %}<img class="geo_icon" src="{{ url_for('static', filename='rnaseq.png') }}"/> RNA-seq{% endif %}
{%- endmacro -%}
{% block head %}
    {{ super() }}
    {{ uber_search_head(virus, tissue) }}
    <style>
        .tooltip {
            position: relative;
            background-color: yellow;
            cursor: default;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 16em;
            background-color: black;
            color: white;
            font-size: smaller;
            text-align: center;
            padding: 5px 0;
            border-radius: 6px;
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -8em;
            z-index: 1;
        }
        .tooltip:hover .tooltiptext { visibility: visible; }
        .tooltip .tooltiptext::after {
            content: " ";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: black transparent transparent transparent;
        }
        abbr { cursor: help; }
    </style>
{% endblock %}
{% block body %}
{{ uber_search_body(search_kids) }}
{% if search_results|length == 0 -%}
<h1>No Results</h1>
{%- else -%}
<h1>{{ search_results|length }} {{ "Result"|pluralize(search_results|length) }}</h1>
<a href="{{ url_for('ui.virus_results_as_text', q=virus, tissue=tissue, descendants=search_kids) }}">Download table as text</a><br><br>
<table class="gse_list">
    <thead>
        <tr>
            <th>Study</th>
            <th>Title</th>
            <th>Analyzed Samples</th>
            <th>Significant Genes</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    {% for result in search_results %}{% set valid_comp = result.pf_samples|length >= 2 and result.pf_controls|length >= 2 %}
        <tr>
            <td><span class="geo_id"><a href="{{ url_for('ui.display_geo_entry', gse_id=result.study) }}">{{ result.study }}</a></span><br>
            <i>{{ result.virus }}</i><br>
            {{ cell_type(result) }}<br>
            {{ platform(result.platform) }}</td>
            <td style="max-width: 30%; width: 30%">{{ result.title }}</td>
            <td>Virus: {{ filtered_count(result.samples|length, result.pf_samples|length, result.missing_sample_reasons) }}<br>
            Control: {{ filtered_count(result.controls|length, result.pf_controls|length, result.missing_control_reasons) }}</td>
            <td><span class="geo_id">{% if valid_comp -%}
                {{ result_link(result.signif|default(0), 'sig', result) }}
            {%- else %}--{% endif %}</span>
            {%- if result.signif|default(0) > 0 -%}
                &nbsp;({{ result_link(result.up|default(0), 'up', result) }}&nbsp;&#x2191; / 
                {{ result_link(result.down|default(0), 'down', result) }}&nbsp;&#x2193;)
            {%- endif %}</td>
            <td>{% if valid_comp -%}
                <a href="{{ url_for('ui.download_results', study=result.study, virus=result.virus, cell_type=result.bto_name, platform=result.platform, geneSet='all') }}">Full Results</a>
            {%- endif %}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{%- endif %}

{% endblock %}