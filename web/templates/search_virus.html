{% extends "base.html" %}
{% block title %}Virus Search{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='autocomplete.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='jstree.style.min.css') }}" />
    <script src="{{ url_for('static', filename='autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='ols-autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='ols-treeview.min.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js" integrity="sha512-RNLkV3d+aLtfcpEyFG8jRbnWHxUqVZozacROI4J2F1sTaDqo1dPQYs01OMi1t1w9Y2FdbSCDSQ2ZVdAC8bzgAg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.3.1/typeahead.bundle.min.js" integrity="sha512-lEb9Vp/rkl9g2E/LdHIMFTqz21+LA79f84gqP75fbimHqVTu6483JG1AwJlWLLQ8ezTehty78fObKupq3HSHPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/jstree.min.js" integrity="sha512-bU6dl4fd2XN3Do3aWypPP2DcKywDyR3YlyszV+rOw9OpglrGyBs6TyTsbglf9umgE+sy+dKm1UHhi07Lv+Vtfg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        window.addEventListener("load", () => init_autocomplete(
            document.getElementById("virus_search"),
            "{{ url_for('api.virus_typeahead', text='') }}",
            function(result, text) {
                var canon = result['species'];
                output = "";
                if (text.toUpperCase() == canon.substr(0, text.length).toUpperCase()) {
                    output += "<i><strong>"+canon.substr(0, text.length)+"</strong>";
                    output += canon.substr(text.length)+"</i>";
                } else {
                    output += "<i>"+canon+"</i>";
                    var foundAlias = false;
                    if (text.toUpperCase() == result['name'].substr(0, text.length).toUpperCase()) {
                        foundAlias = true;
                        output += " (<strong>"+result['name'].substr(0, text.length)+"</strong>";
                        output += result['name'].substr(text.length)+")";
                    }
                    if (!foundAlias) {
                        for (var i=0; i<result['aliases'].length; i++) {
                            var name = result['aliases'][i];
                            if (text.toUpperCase() == name.substr(0, text.length).toUpperCase()) {
                                foundAlias = true;
                                output += " (<strong>"+name.substr(0, text.length)+"</strong>";
                                output += name.substr(text.length)+")";
                                break;
                            }
                        }
                    }
                }
                return output+"<input type='hidden' value='" + canon + "'>";
            }
        ));
        window.addEventListener('load', () => {
            toggle_link = document.getElementById("toggletree");
            toggle_link.addEventListener("click", () => {
                treeview = document.getElementById("term-tree");
                if (treeview.style.display == "none") {
                    treeview.style.display = "block";
                    toggle_link.innerHTML = "Hide Tissue Tree";
                } else {
                    treeview.style.display = "none";
                    toggle_link.innerHTML = "Show Tissue Tree";
                }
            });
        });
        function parse_iri(iri) {
            return iri.substr(iri.lastIndexOf('/')+1).replace('_', ':');
        }
        $(document).ready(function() {
            $("#ols-autocomplete").on('blur', function() {
                text = $(this).typeahead('val');
                cache = $("#tissue").data("bto_name");
                if ((text == "") || (text == cache)) {
                    $(this).css({'border-color': ''});
                    $("input[type='submit']").prop("disabled", false);
                    if (text == "") $("#tissue").val("");
                } else {
                    $("#tissue").val("");
                    $(this).css({'border-color': 'red'});
                    $("input[type='submit']").prop("disabled", true);
                }
            });
            var ac_app = require("ols-autocomplete");
            var ac_instance = new ac_app();
            var tv_app = require("ols-treeview");
            var tv_instance = new tv_app();

            tv_options = {
                onclick: function(params, node, relativePath, termIRI, type) {
                    $("#ols-autocomplete").typeahead('val', node.node.text);
                    $("#tissue").val(parse_iri(node.node.a_attr.iri));
                    $("#tissue").data("bto_name", node.node.text);
                    $("input[type='submit']").prop("disabled", false);
                }
            };
            ac_instance.start({
                action: function(relativePath, suggestion_ontology, type, iri, data, value) {
                    tv_instance.draw($("#term-tree"), false, "bto", "terms", iri, "https://www.ebi.ac.uk/ols/", tv_options);
                    $("#tissue").val(parse_iri(iri));
                    $("#tissue").data("bto_name", value);
                    $("input[type='submit']").prop("disabled", false);
                }
            });

            tv_instance.draw($("#term-tree"), false, "bto", "terms", "", "https://www.ebi.ac.uk/ols/", tv_options);

        });
    </script>
{% endblock %}
{% block body %}
    <form autocomplete="off" action="{{ url_for('ui.virus_results') }}" method="GET">
        <input type="hidden" name="tissue" id="tissue" />
        <div id="filtercontainer">
            <div id="filters">
                <h3>Select analyses</h3>
                <div class="autocomplete">
                    <input type="text" class="searchbox" id="virus_search" 
                    size="40" name="q" placeholder="Virus name" autofocus/>
                </div><br>
                <input type="text" size="40" placeholder="Tissue/Cell type" data-olswidget="select" 
                data-olsontology="bto" data-selectpath="https://www.ebi.ac.uk/ols/" id="ols-autocomplete"
                style="font-weight: normal" class="searchbox" /><br>
                <input type="checkbox" name="descendants" id="kids" value="1" checked />
                <label for="kids">Include more specific tissues?</label><br />
                <input type="submit" value="Search" />                        
            </div>
            <div id="filterhelp">
                <div id="helpbox">

                </div>
                <span id="toggletree">Show Tissue Tree</span>
            </div>
        </div>
        <div id="term-tree" style="display: none"></div>
    </form>
{% endblock %}